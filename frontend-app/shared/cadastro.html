<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro - Firm Capital</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/auth.css" />
  </head>
  <body>
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <img
            src="../images/logos/logo_firm.png"
            alt="Firm Capital"
            class="auth-logo"
          />
          <h1>Criar Conta</h1>
          <p>Preencha seus dados para começar</p>
        </div>

        <div class="auth-body">
          <form id="cadastroForm" class="auth-form">
            <div class="form-group">
              <label for="nome">Nome Completo *</label>
              <input
                type="text"
                id="nome"
                name="nome"
                placeholder="Seu nome completo"
                required
                autocomplete="name"
              />
            </div>

            <div class="form-group">
              <label for="email">Email *</label>
              <input
                type="email"
                id="email"
                name="email"
                placeholder="seu@email.com"
                required
                autocomplete="email"
              />
            </div>

            <div class="form-group">
              <label for="telefone">Telefone</label>
              <input
                type="tel"
                id="telefone"
                name="telefone"
                placeholder="(00) 00000-0000"
                autocomplete="tel"
              />
            </div>

            <div class="form-group">
              <label for="senha">Senha *</label>
              <div class="password-toggle">
                <input
                  type="password"
                  id="senha"
                  name="senha"
                  placeholder="Mínimo 6 caracteres"
                  required
                  autocomplete="new-password"
                />
                <button
                  type="button"
                  class="password-toggle-btn"
                  onclick="togglePassword('senha')"
                >
                  <i class="fas fa-eye" id="toggleIconSenha"></i>
                </button>
              </div>
              <small class="form-error" id="senhaError"></small>
            </div>

            <div class="form-group">
              <label for="confirmarSenha">Confirmar Senha *</label>
              <div class="password-toggle">
                <input
                  type="password"
                  id="confirmarSenha"
                  name="confirmarSenha"
                  placeholder="Digite a senha novamente"
                  required
                  autocomplete="new-password"
                />
                <button
                  type="button"
                  class="password-toggle-btn"
                  onclick="togglePassword('confirmarSenha')"
                >
                  <i class="fas fa-eye" id="toggleIconConfirmarSenha"></i>
                </button>
              </div>
              <small class="form-error" id="confirmarSenhaError"></small>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="termos" name="termos" required />
              <label for="termos">
                Aceito os <a href="#" target="_blank">termos de uso</a> e
                <a href="#" target="_blank">política de privacidade</a>
              </label>
            </div>

            <button type="submit" class="btn" id="cadastroBtn">
              Criar Conta
            </button>
          </form>
        </div>

        <div class="auth-footer">
          <p>Já tem uma conta? <a href="login.html">Fazer login</a></p>
        </div>
      </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/utils.js"></script>

    <script>
      // Verificar se já está logado
      if (auth.isAuthenticated()) {
        auth.redirectToDashboard();
      }

      // Toggle mostrar/ocultar senha
      function togglePassword(fieldId) {
        const senhaInput = document.getElementById(fieldId);
        const toggleIcon = document.getElementById(
          `toggleIcon${fieldId.charAt(0).toUpperCase() + fieldId.slice(1)}`
        );

        if (senhaInput.type === "password") {
          senhaInput.type = "text";
          toggleIcon.classList.remove("fa-eye");
          toggleIcon.classList.add("fa-eye-slash");
        } else {
          senhaInput.type = "password";
          toggleIcon.classList.remove("fa-eye-slash");
          toggleIcon.classList.add("fa-eye");
        }
      }

      // Validação de senha em tempo real
      document.getElementById("senha").addEventListener("input", function () {
        const senha = this.value;
        const errorEl = document.getElementById("senhaError");

        if (senha.length > 0 && senha.length < 6) {
          errorEl.textContent = "Senha deve ter no mínimo 6 caracteres";
        } else {
          errorEl.textContent = "";
        }
      });

      // Validação de confirmação de senha
      document
        .getElementById("confirmarSenha")
        .addEventListener("input", function () {
          const senha = document.getElementById("senha").value;
          const confirmarSenha = this.value;
          const errorEl = document.getElementById("confirmarSenhaError");

          if (confirmarSenha.length > 0 && senha !== confirmarSenha) {
            errorEl.textContent = "As senhas não coincidem";
          } else {
            errorEl.textContent = "";
          }
        });

      // Máscara de telefone
      document
        .getElementById("telefone")
        .addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "");

          if (value.length <= 11) {
            if (value.length <= 10) {
              value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, "($1) $2-$3");
            } else {
              value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, "($1) $2-$3");
            }
            e.target.value = value;
          }
        });

      // Handle cadastro
      document
        .getElementById("cadastroForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const nome = document.getElementById("nome").value.trim();
          const email = document.getElementById("email").value.trim();
          const telefone = document.getElementById("telefone").value.trim();
          const senha = document.getElementById("senha").value;
          const confirmarSenha =
            document.getElementById("confirmarSenha").value;
          const termos = document.getElementById("termos").checked;

          // Validações
          if (nome.length < 3) {
            showToast("Nome deve ter no mínimo 3 caracteres", "error");
            return;
          }

          if (!isValidEmail(email)) {
            showToast("Email inválido", "error");
            return;
          }

          if (senha.length < 6) {
            showToast("Senha deve ter no mínimo 6 caracteres", "error");
            return;
          }

          if (senha !== confirmarSenha) {
            showToast("As senhas não coincidem", "error");
            return;
          }

          if (!termos) {
            showToast("Você deve aceitar os termos de uso", "error");
            return;
          }

          const cadastroBtn = document.getElementById("cadastroBtn");
          cadastroBtn.disabled = true;
          cadastroBtn.textContent = "Criando conta...";

          try {
            const response = await api.register({
              nome,
              email,
              senha,
              telefone: telefone || undefined,
            });

            if (response.success) {
              showToast("Conta criada com sucesso!", "success");

              // Aguardar e redirecionar
              setTimeout(() => {
                auth.redirectToDashboard();
              }, 1000);
            }
          } catch (error) {
            handleError(error);
            cadastroBtn.disabled = false;
            cadastroBtn.textContent = "Criar Conta";
          }
        });
    </script>
  </body>
</html>
